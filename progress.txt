## Reminder

**Examples of good progress.txt additions:**
- "When modifying X, also update Y to keep them in sync"
- "This module uses pattern Z for all API calls"
- "Tests require the dev server running on PORT 3000"
- "Field names must match the template exactly"

**Do NOT add:**
- Story-specific implementation details
- Temporary debugging notes
- Information already in progress.txt

---
## Codebase Patterns
- Kafka client functions in `kafka_client.py` catch all exceptions internally, log warnings, return empty/zero values — never raise
- Module imports inside functions (e.g., `from kafka_client import get_committed_offsets` inside `_process_group`) require patching at the source module, not the calling module
- Use `uv pip` instead of `pip`, `uv run python` instead of `python`
- SQLite PRAGMA `auto_vacuum=INCREMENTAL` must be set BEFORE creating tables and requires a `commit()` to take effect
- Each worker thread (Sampler, Reporter, Housekeeping, StateManager) should receive `db_path` string and create its own connection via `database.get_connection(db_path)` - never share a connection across threads
- Tests that use StateManager/Reporter/Housekeeping need initialized database; use `db_path_initialized` fixture from conftest.py
- When calling `get_committed_offsets` from kafka_client, convert Set to List since the function expects List[Tuple[str, int]]

---
## Learnings
Kafka / Distributed Systems

When a function creates a resource that's needed later, return it for reuse rather than creating another instance
The describe_consumer_groups call already provides per-group partition data — don't discard it
Idle group detection relies on per-group partition assignments; groups with no active assignments properly return empty partition sets

Testing / Patching

When patching function imports inside methods, patch at the source module (e.g. kafka_client.get_committed_offsets) not the calling module
Tests that create workers (StateManager, Reporter, Housekeeping) need an initialized database — use a db_path_initialized fixture
Fix test fixtures to use db_path instead of passing connections directly

SQLite

PRAGMA auto_vacuum must be set BEFORE creating tables and requires an explicit commit
PRAGMA statements don't support bound parameters — validate input first, then use an f-string
When you only need one value from a table, write a purpose-built query rather than fetching all rows and extracting one

Worker / Threading Patterns

SQLite connections should be per-thread — pass db_path and let each worker create its own connection
For timed worker loops: capture cycle_start, run work, calculate elapsed, subtract from interval, sleep max(0, remainder) — prevents back-to-back cycles when work exceeds the interval

State / Business Logic

New groups start with consecutive_static=0 and will report ONLINE for threshold cycles before being detectable as OFFLINE — this is a known startup blind spot, not a bug
Groups with DB history are identified by presence in the consumer_commits table
When marking idle groups as OFFLINE, iterate over all previously tracked topics for that group
RECOVERING groups are actively consuming, so they warrant "fine" resolution — only OFFLINE should produce "coarse" resolution


---
## Progress updates

## 2026-02-22 18:03 - TASK 32, 33, 34 - Sampler fixes
- TASK 33: Fixed _evaluate_state_machine to not set any_advancing=True when history is sparse (insufficient data != advancing). This was causing false RECOVERING transitions.
- TASK 32: Added augmentation of all_topic_partitions with idle groups' historical partitions from consumer_commits to keep partition_offsets fresh for idle groups
- TASK 34: Fixed _handle_idle_group to preserve last_advancing_at from existing DB state instead of setting to current_time when marking groups as OFFLINE
- Files changed: src/database.py, src/sampler.py, src/tests/test_database.py, src/tests/test_sampler.py
- **Learnings for future iterations:**
  - When fixing state machine bugs, tests may be testing buggy behavior - need to update tests to reflect correct behavior
  - Added get_all_groups_with_history() function to database.py for finding idle groups with history
  - The state machine is conservative: requires positive evidence of advancement, not absence of evidence of stasis
---

## 2026-02-22 19:30 - TASK 35 - Batch commits in sampler write path
- Removed conn.commit() from insert_partition_offset and insert_consumer_commit in database.py
- Added commit_batch() function to database.py for explicit batch commits
- Added commit_batch() call at end of sampler cycle in sampler.py
- Updated tests in test_sampler.py, test_housekeeping.py, test_reporter.py to call commit_batch after inserts
- Files changed: src/database.py, src/sampler.py, src/tests/test_sampler.py, src/tests/test_housekeeping.py, src/tests/test_reporter.py
- **Learnings for future iterations:**
  - When removing auto-commit from insert functions, all callers (tests and code) need to explicitly call commit_batch
  - Tests using worker threads need to use the worker's connection (e.g., s._db_conn) not the fixture connection for queries after operations
  - WAL mode should allow visibility across connections, but explicit commit is still needed for durability
---

## 2026-02-22 20:00 - TASK 36 - StateManager lock scope reduction
- Reduced lock scope in set_group_status: lock now only protects in-memory dict update, DB write happens outside lock
- Fixed thread-safety by creating new DB connection per write operation instead of sharing StateManager's connection
- Files changed: src/state_manager.py
- **Learnings for future iterations:**
  - Moving DB I/O outside locks can expose pre-existing threading bugs - test with concurrent access
  - SQLite connections are not thread-safe; create new connection per operation for concurrent access
  - The original code serialized DB writes via the lock, masking the connection-sharing bug
